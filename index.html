<!doctype html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>משגר הודעות ל־Google Chat</title>
<style>
html, body {
    height: 100%;
    margin: 0;
    padding: 0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    width: 100%;
    overflow: hidden;
}
body {
    display: flex;
    gap: 20px;
    padding: 20px;
    background: #f0f4f8;
    height: 100vh;
    box-sizing: border-box;
}
#main-flex {
    display: flex;
    gap: 20px;
    flex: 1;
    height: 100%;
}
.container {
    flex: 1;
    display: flex;
    flex-direction: column;
    background: white;
    border-radius: 16px;
    padding: 24px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.12);
    max-width: none;
    height: 100%;
    overflow: auto;
}
h1 { font-size:26px; margin:0 0 20px 0; color:#1f2937; text-align:center; }
label { display:block; margin-top:14px; font-weight:600; color:#374151; }
input[type=text], textarea, select {
    width:100%; padding:10px 14px; margin-top:6px; border:1px solid #cbd5e1;
    border-radius:10px; font-size:15px; background:#f9fafb; transition:border 0.2s;
}
input[type=text]:focus, textarea:focus, select:focus { border-color:#3b82f6; outline:none; }
textarea { min-height:100px; resize:vertical; }
.row { display:flex; gap:12px; }
.col { flex:1; }
button {
    margin-top:14px; padding:12px 18px; border-radius:12px; border:0;
    background:#3b82f6; color:white; font-weight:700; cursor:pointer;
    box-shadow:0 4px 12px rgba(0,0,0,0.15); transition: background 0.2s, transform 0.1s;
}
button:hover { background:#2563eb; transform:translateY(-1px); }
.muted { color:#6b7280; font-size:13px; }
.images-list { margin-top:10px; display:flex; gap:10px; flex-wrap:wrap; }
.images-list img { width:120px; height:80px; object-fit:cover; border-radius:8px; border:1px solid #d1d5db; cursor:pointer; }
.flex-between { display:flex; justify-content:space-between; align-items:center; margin-top:16px; }
.small { font-size:13px; color:#6b7280; }
.preview-card { border:1px solid #e5e7eb; border-radius:12px; padding:0; margin-top:14px; background:#fefefe; overflow:hidden; width:100%; box-shadow:0 2px 10px rgba(0,0,0,0.08); }
.card-header { background:#f3f4f6; padding:14px 16px; }
.card-header strong { font-size:17px; display:block; color:#111827; }
.card-header span { font-size:15px; color:#4b5563; display:block; margin-top:4px; }
.card-header img { width:100%; border-radius:8px; margin-top:8px; }
.section { border-top:1px solid #e5e7eb; padding:12px 16px; display:flex; flex-direction:column; gap:8px; }
.section p { margin:0; line-height:1.5; color:#1f2937; }
.section img { max-width:100%; border-radius:8px; cursor:pointer; }
.action-button { display:inline-block; margin-top:6px; padding:6px 12px; border-radius:8px; background:#3b82f6; color:white; font-weight:600; text-decoration:none; transition: background 0.2s; }
.action-button:hover { background:#2563eb; }
#history-container {
    width:400px; background:#f9fafb; border-radius:16px; padding:14px;
    box-shadow:0 6px 20px rgba(0,0,0,0.12); overflow:auto; flex-shrink:0;
    display:flex; flex-direction:column; height: 100%;
}
#history-container h3 { margin-top:0; }
.history-item { margin-bottom:16px; border-radius:12px; padding:10px 12px; box-shadow:0 2px 8px rgba(0,0,0,0.08); transition: transform 0.15s; }
.history-item:hover { transform:translateY(-2px); }
.history-timestamp { font-size:13px; color:#4b5563; margin-bottom:6px; font-weight:500; }
#preview { flex: 1; overflow:auto; border:1px solid #e5e7eb; border-radius:12px; padding:10px; margin-top:12px; min-height: 200px; }
</style>
</head>
<body>
<div id="main-flex">
<div class="container">
<h1>משגר הודעות ל־Google Chat</h1>

<label>Webhook URL</label>
<input id="webhook" type="text" placeholder="https://chat.googleapis.com/v1/spaces/...">

<div class="row" style="margin-top:12px">
  <div class="col">
    <label>סוג ההודעה</label>
    <select id="mode">
      <option value="text">טקסט פשוט</option>
      <option value="card" selected>כרטיס (כותרת+תמונה)</option>
    </select>
  </div>
  <div class="col">
    <label>התנהגות לאחר שליחה</label>
    <select id="after">
      <option value="keep">השאר את הטופס</option>
      <option value="clear">נקה שדות לאחר שליחה</option>
    </select>
  </div>
</div>

<div id="textArea" style="margin-top:12px">
  <label>טקסט להודעה (טקסט פשוט)</label>
  <textarea id="plainText" placeholder="כתוב כאן את ההודעה הפשוטה שלך..."></textarea>
</div>

<div id="cardArea" style="margin-top:12px">
  <label>כותרת (title)</label>
  <input id="title" type="text" placeholder="כותרת הכרטיס">

  <label>תת-כותרת (subtitle)</label>
  <input id="subtitle" type="text" placeholder="תת-כותרת">

  <label>תמונה בכותרת (header image URL)</label>
  <input id="headerImage" type="text" placeholder="https://example.com/header.jpg">

  <label>טקסט בכרטיס (textParagraph)</label>
  <textarea id="cardText" placeholder="טקסט שיופיע בכרטיס..."></textarea>

  <label>כתובות תמונה (כל כתובת בשורה חדשה)</label>
  <textarea id="images" placeholder="https://example.com/image1.jpg"></textarea>

  <label>פעולות (Action buttons) – כל פעולה בשורה, בפורמט: כותרת|URL</label>
  <textarea id="actions" placeholder="למשל: פתח אתר|https://example.com"></textarea>

  <div class="images-list" id="imagesPreview"></div>
</div>

<div class="flex-between">
  <div>
    <button id="build">בנה תצוגה מקדימה</button>
    <button id="send" style="margin-left:8px">שלח עכשיו</button>
  </div>
  <div class="small muted">Google Chat cards עם image + action widgets</div>
</div>

<label style="margin-top:12px">תצוגה מקדימה חיה</label>
<div id="preview"></div>

<label style="margin-top:12px">סטטוס / לוג</label>
<pre id="log">מוכן.</pre>
</div>

<div id="history-container">
<h3>היסטוריית הודעות</h3>
<div id="history"></div>
</div>
</div>

<script>
document.addEventListener('DOMContentLoaded', ()=>{
const modeEl=document.getElementById('mode');
const cardArea=document.getElementById('cardArea');
const textArea=document.getElementById('textArea');
const imagesEl=document.getElementById('images');
const imagesPreview=document.getElementById('imagesPreview');
const actionsEl=document.getElementById('actions');
const previewEl=document.getElementById('preview');
const logEl=document.getElementById('log');
const historyEl=document.getElementById('history');

function updateVisibility(){ textArea.style.display=modeEl.value==='text'?'block':'none'; cardArea.style.display=modeEl.value==='card'?'block':'none'; }
modeEl.addEventListener('change',updateVisibility);
updateVisibility();

function buildPayload(){
  if(modeEl.value==='text') return {text:document.getElementById('plainText').value.trim()||' '};

  const title=document.getElementById('title').value.trim();
  const subtitle=document.getElementById('subtitle').value.trim();
  const headerImage=document.getElementById('headerImage').value.trim();
  const cardText=document.getElementById('cardText').value.trim();
  const imagesRaw=imagesEl.value.split('\n').map(s=>s.trim()).filter(Boolean);
  const actionsRaw=actionsEl.value.split('\n').map(s=>s.trim()).filter(Boolean);

  const card={}; 
  if(title||subtitle||headerImage) card.header={};
  if(title) card.header.title=title;
  if(subtitle) card.header.subtitle=subtitle;
  if(headerImage) card.header.imageUrl=headerImage;

  const widgets=[];
  if(cardText) widgets.push({textParagraph:{text:cardText}});
  imagesRaw.forEach(url=>widgets.push({image:{imageUrl:url}}));
  card.sections = [];
  if(widgets.length) card.sections.push({widgets});

  actionsRaw.forEach(line=>{
    const [text,url] = line.split('|').map(s=>s.trim());
    if(text && url){
      card.sections.push({widgets:[{buttons:[{textButton:{text,onClick:{openLink:{url}}}}]}]});
    }
  });

  return {cards:[card]};
}

function renderImagesPreview(){
  imagesPreview.innerHTML='';
  imagesEl.value.split('\n').map(s=>s.trim()).filter(Boolean).forEach(u=>{
    const img=document.createElement('img'); img.src=u; img.loading='lazy'; imagesPreview.appendChild(img);
  });
}
imagesEl.addEventListener('input', renderImagesPreview);
renderImagesPreview();

function renderPreview(payload=buildPayload(), target=previewEl){
  target.innerHTML='';
  if(!payload.cards){ target.textContent=payload.text; return; }
  payload.cards.forEach(card=>{
    const cardDiv=document.createElement('div'); cardDiv.className='preview-card';
    if(card.header){
      const headerDiv=document.createElement('div'); headerDiv.className='card-header';
      if(card.header.imageUrl){ const img=document.createElement('img'); img.src=card.header.imageUrl; headerDiv.appendChild(img); }
      if(card.header.title) headerDiv.innerHTML += `<strong>${card.header.title}</strong>`;
      if(card.header.subtitle) headerDiv.innerHTML += `<span>${card.header.subtitle}</span>`;
      cardDiv.appendChild(headerDiv);
    }
    if(card.sections){
      card.sections.forEach(section=>{
        const secDiv=document.createElement('div'); secDiv.className='section';
        section.widgets.forEach(widget=>{
          if(widget.textParagraph){ const p=document.createElement('p'); p.textContent=widget.textParagraph.text; secDiv.appendChild(p); }
          if(widget.image){ const img=document.createElement('img'); img.src=widget.image.imageUrl; img.addEventListener('click',()=>{
            const current=imagesEl.value.split('\n').map(s=>s.trim()).filter(Boolean);
            if(!current.includes(img.src)) current.push(img.src);
            imagesEl.value=current.join('\n');
            renderImagesPreview();
          }); secDiv.appendChild(img); }
          if(widget.buttons){
            widget.buttons.forEach(btn=>{
              const a=document.createElement('a');
              a.href=btn.textButton.onClick.openLink.url;
              a.target="_blank"; a.className='action-button';
              a.textContent=btn.textButton.text;
              secDiv.appendChild(a);
            });
          }
        });
        cardDiv.appendChild(secDiv);
      });
    }
    target.appendChild(cardDiv);
  });
}

function saveHistory(payload){
    const history = JSON.parse(localStorage.getItem('chatHistory')||'[]');
    const item = { timestamp: Date.now(), type: payload.text?'text':'card', text: payload.text||'', cards: payload.cards||[] };
    history.unshift(item);
    localStorage.setItem('chatHistory', JSON.stringify(history.slice(0,50)));
    renderHistory();
}

function renderHistory(){
  const history=JSON.parse(localStorage.getItem('chatHistory')||'[]');
  historyEl.innerHTML='';
  history.forEach(item=>{
    const div=document.createElement('div'); div.className='history-item';
    const tsDiv=document.createElement('div'); tsDiv.className='history-timestamp';
    tsDiv.textContent=new Date(item.timestamp).toLocaleString();
    div.appendChild(tsDiv);
    const previewContainer=document.createElement('div');
    renderPreview(item, previewContainer);
    div.appendChild(previewContainer);
    historyEl.appendChild(div);
  });
}

function sendToWebhook(payload) {
    const webhookUrl = document.getElementById('webhook').value.trim();
    if (!webhookUrl) { logEl.textContent = 'נא להזין Webhook URL!'; return; }
    fetch(webhookUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    })
    .then(response => { if(!response.ok) throw new Error('HTTP error ' + response.status); logEl.textContent = 'נשלח בהצלחה!'; })
    .catch(err => { logEl.textContent = 'שגיאה בשליחה: ' + err.message; });
}

document.getElementById('build').addEventListener('click',()=>renderPreview());
document.getElementById('send').addEventListener('click',()=>{
  const payload = buildPayload();
  saveHistory(payload);
  sendToWebhook(payload);
  if(document.getElementById('after').value==='clear'){
    document.getElementById('plainText').value='';
    document.getElementById('title').value='';
    document.getElementById('subtitle').value='';
    document.getElementById('headerImage').value='';
    document.getElementById('cardText').value='';
    document.getElementById('images').value='';
    document.getElementById('actions').value='';
    renderImagesPreview();
    renderPreview();
  }
});

renderHistory();
});
</script>
</body>
</html>
