<!doctype html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>משגר הודעות ל-Google Chat — עם המרת GitHub ל-raw</title>
<style>
  html,body{height:100%;margin:0;padding:0;font-family:Segoe UI, Tahoma, Geneva, Verdana, sans-serif;direction:rtl}
  body{display:flex;gap:20px;padding:20px;background:#f0f4f8;height:100vh;box-sizing:border-box}
  #main-flex{display:flex;gap:20px;flex:1;height:100%}
  .container{flex:1;display:flex;flex-direction:column;background:white;border-radius:16px;padding:24px;box-shadow:0 8px 24px rgba(0,0,0,0.12);height:100%;overflow:auto}
  h1{font-size:26px;margin:0 0 20px 0;color:#1f2937;text-align:center}
  label{display:block;margin-top:14px;font-weight:600;color:#374151}
  input[type=text],textarea,select{width:100%;padding:10px 14px;margin-top:6px;border:1px solid #cbd5e1;border-radius:10px;font-size:15px;background:#f9fafb}
  textarea{min-height:100px;resize:vertical}
  button{margin-top:14px;padding:12px 18px;border-radius:12px;border:0;background:#3b82f6;color:#fff;font-weight:700;cursor:pointer}
  button:hover{background:#2563eb}
  .images-list{margin-top:10px;display:flex;gap:10px;flex-wrap:wrap}
  .images-list img{width:120px;height:80px;object-fit:cover;border-radius:8px;border:1px solid #d1d5db;cursor:pointer}
  .preview-card{border:1px solid #e5e7eb;border-radius:12px;padding:0;margin-top:14px;background:#fff;overflow:hidden}
  .card-header{background:#f3f4f6;padding:14px 16px}
  .card-header img{width:100%;border-radius:8px;margin-top:8px}
  .section{border-top:1px solid #e5e7eb;padding:12px 16px;display:flex;flex-direction:column;gap:8px}
  .action-button{display:inline-block;margin-top:6px;padding:6px 12px;border-radius:8px;background:#3b82f6;color:#fff;text-decoration:none}
  #history-container{width:380px;background:#f9fafb;border-radius:16px;padding:14px;box-shadow:0 6px 20px rgba(0,0,0,0.12);overflow:auto;flex-shrink:0;display:flex;flex-direction:column;height:100%}
  #preview{flex:1;overflow:auto;border:1px solid #e5e7eb;border-radius:12px;padding:10px;margin-top:12px;min-height:200px}
  pre#log{background:#111827;color:#e6eef8;padding:12px;border-radius:8px;height:160px;overflow:auto}
</style>
</head>
<body>
<div id="main-flex">
  <div class="container">
    <h1>משגר הודעות ל-Google Chat</h1>

    <label>Webhook URL</label>
    <input id="webhook" type="text" placeholder="https://chat.googleapis.com/v1/spaces/...">

    <label>סוג ההודעה</label>
    <select id="mode">
      <option value="text">טקסט פשוט</option>
      <option value="card" selected>כרטיס (כותרת + תמונות)</option>
    </select>

    <label style="margin-top:12px">התנהגות לאחר שליחה</label>
    <select id="after">
      <option value="keep">השאר את הטופס</option>
      <option value="clear">נקה שדות לאחר שליחה</option>
    </select>

    <div id="textArea" style="margin-top:12px">
      <label>טקסט להודעה (טקסט פשוט)</label>
      <textarea id="plainText"></textarea>
    </div>

    <div id="cardArea" style="margin-top:12px">
      <label>כותרת (title)</label>
      <input id="title" type="text" placeholder="כותרת הכרטיס">
      <label>תת-כותרת (subtitle)</label>
      <input id="subtitle" type="text" placeholder="תת-כותרת">
      <label>תמונה בכותרת (header image URL)</label>
      <input id="headerImage" type="text" placeholder="https://...">
      <label>טקסט בכרטיס</label>
      <textarea id="cardText" placeholder="טקסט בתוך הכרטיס..."></textarea>
      <label>כתובות תמונה (כל כתובת בשורה חדשה)</label>
      <textarea id="images" placeholder="https://example.com/img1.png"></textarea>
      <div class="images-list" id="imagesPreview"></div>
    </div>

    <div style="display:flex;gap:8px;margin-top:12px">
      <button id="build">בנה תצוגה מקדימה</button>
      <button id="send">שלח עכשיו</button>
    </div>

    <label style="margin-top:12px">תצוגה מקדימה חיה</label>
    <div id="preview"></div>

    <label style="margin-top:12px">לוג ושליטה</label>
    <pre id="log">מוכן.</pre>
  </div>

  <div id="history-container">
    <h3>היסטורית הודעות</h3>
    <div id="history"></div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', ()=>{

  const githubBlobDefault = "https://github.com/shey3132/-22/blob/main/%D7%A4%D7%A8%D7%95%D7%A4%D7%99%D7%9C%20%D7%93%D7%99%D7%92%D7%99%D7%98%D7%9C%D7%99%20%D7%A2%D7%9D%20%D7%A8%D7%A9%D7%AA%20%D7%A4%D7%A2%D7%95%D7%9C%D7%94.png?raw=true";

  const modeEl = document.getElementById('mode');
  const cardArea = document.getElementById('cardArea');
  const textArea = document.getElementById('textArea');
  const imagesEl = document.getElementById('images');
  const imagesPreview = document.getElementById('imagesPreview');
  const previewEl = document.getElementById('preview');
  const logEl = document.getElementById('log');
  const historyEl = document.getElementById('history');

  function updateVisibility(){ textArea.style.display = modeEl.value==='text'?'block':'none'; cardArea.style.display = modeEl.value==='card'?'block':'none'; }
  modeEl.addEventListener('change', updateVisibility);
  updateVisibility();

  // פונקציה להמרת github.com/.../blob/... ל raw.githubusercontent.com/...
  function toRawGitHubUrl(url){
    try{
      if(!url) return url;
      const u = new URL(url);
      const host = u.hostname.toLowerCase();
      if(host.includes('raw.githubusercontent.com')) return url; // כבר raw
      if(!host.includes('github.com')) return url; // לא github
      // path parts
      const parts = u.pathname.split('/').filter(Boolean);
      const blobIdx = parts.indexOf('blob');
      if(blobIdx === -1 || parts.length < blobIdx + 2) return url;
      const user = parts[0], repo = parts[1], branch = parts[blobIdx + 1];
      const rawPath = parts.slice(blobIdx + 2).join('/');
      return `https://raw.githubusercontent.com/${user}/${repo}/${branch}/${rawPath}`;
    }catch(e){
      return url;
    }
  }

  function renderImagesPreview(){
    imagesPreview.innerHTML='';
    imagesEl.value.split('\n').map(s=>s.trim()).filter(Boolean).forEach(u=>{
      const img = document.createElement('img');
      img.src = u;
      img.loading = 'lazy';
      imagesPreview.appendChild(img);
    });
  }
  imagesEl.addEventListener('input', renderImagesPreview);
  renderImagesPreview();

  function buildPayload(){
    if(modeEl.value==='text') return { text: document.getElementById('plainText').value.trim() || ' ' };

    const title = document.getElementById('title').value.trim();
    const subtitle = document.getElementById('subtitle').value.trim();
    // קח את מה שבשדה או את ברירת המחדל מה־Github ואז המר ל־raw
    const headerRawInput = document.getElementById('headerImage').value.trim() || githubBlobDefault;
    const headerFinal = toRawGitHubUrl(headerRawInput);

    const cardText = document.getElementById('cardText').value.trim();
    const imagesRaw = imagesEl.value.split('\n').map(s=>s.trim()).filter(Boolean);
    const actionsRaw = []; // לא משתמשים כרגע בפעולות, אפשר להוסיף כמו קודם

    const card = {};
    if(title || subtitle || headerFinal){
      card.header = {};
      if(title) card.header.title = title;
      if(subtitle) card.header.subtitle = subtitle;
      if(headerFinal) card.header.imageUrl = headerFinal;
    }

    // בנו ווידג'טים — ודאגו להמיר כל URL ל-raw
    const widgets = [];
    if(cardText) widgets.push({ textParagraph: { text: cardText } });
    const finalImageUrls = [];
    imagesRaw.forEach(url=>{
      const final = toRawGitHubUrl(url);
      finalImageUrls.push(final);
      widgets.push({ image: { imageUrl: final } });
    });

    card.sections = widgets.length ? [{ widgets }] : [];

    // לצורף לוג קצר של הכתובות הסופיות שנשלחות
    logEl.textContent = 'Final image URLs:\n' + (headerFinal ? ('header: ' + headerFinal + '\n') : '') +
                      (finalImageUrls.length ? ('images:\n' + finalImageUrls.join('\n')) : '(no images)') +
                      '\n\nBuilding payload...';

    const payload = { cards: [card] };
    // הדפס גם לקונסול
    console.log('Built payload (with final image URLs):', payload);
    return payload;
  }

  function renderPreview(payload = buildPayload(), target = previewEl){
    target.innerHTML = '';
    if(!payload.cards){
      target.textContent = payload.text;
      return;
    }
    payload.cards.forEach(card=>{
      const cardDiv = document.createElement('div'); cardDiv.className='preview-card';
      if(card.header){
        const headerDiv = document.createElement('div'); headerDiv.className='card-header';
        if(card.header.imageUrl){
          const img = document.createElement('img'); img.src = card.header.imageUrl; headerDiv.appendChild(img);
        }
        if(card.header.title) headerDiv.innerHTML += `<strong>${card.header.title}</strong>`;
        if(card.header.subtitle) headerDiv.innerHTML += `<span>${card.header.subtitle}</span>`;
        cardDiv.appendChild(headerDiv);
      }
      if(card.sections){
        card.sections.forEach(sec=>{
          const secDiv = document.createElement('div'); secDiv.className='section';
          sec.widgets.forEach(widget=>{
            if(widget.textParagraph){ const p=document.createElement('p'); p.textContent = widget.textParagraph.text; secDiv.appendChild(p); }
            if(widget.image){ const img=document.createElement('img'); img.src = widget.image.imageUrl; secDiv.appendChild(img); }
          });
          cardDiv.appendChild(secDiv);
        });
      }
      target.appendChild(cardDiv);
    });
  }

  function saveHistory(payload){
    const history = JSON.parse(localStorage.getItem('chatHistory')||'[]');
    const item = { timestamp: Date.now(), type: payload.text ? 'text' : 'card', text: payload.text || '', cards: payload.cards || [] };
    history.unshift(item); localStorage.setItem('chatHistory', JSON.stringify(history.slice(0,50)));
    renderHistory();
  }

  function renderHistory(){
    const history = JSON.parse(localStorage.getItem('chatHistory')||'[]');
    historyEl.innerHTML = '';
    history.forEach(item=>{
      const div = document.createElement('div'); div.className='history-item';
      const ts = document.createElement('div'); ts.className='history-timestamp';
      ts.textContent = new Date(item.timestamp).toLocaleString(); div.appendChild(ts);
      const previewContainer = document.createElement('div');
      renderPreview(item, previewContainer);
      div.appendChild(previewContainer);
      historyEl.appendChild(div);
    });
  }

  async function sendToWebhook(payload){
    const webhookUrl = document.getElementById('webhook').value.trim();
    if(!webhookUrl){ logEl.textContent = 'שגיאה: לא הוזן Webhook URL.'; return; }

    logEl.textContent = 'שולח ל-webhook...\n\n' + JSON.stringify(payload, null, 2) + '\n\n(בדוק גם ה-Console)';
    console.log('Sending payload to webhook:', payload);

    try{
      const resp = await fetch(webhookUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      const text = await resp.text();
      if(!resp.ok){
        logEl.textContent = `שגיאה בשליחה: HTTP ${resp.status}\nResponse body:\n${text}`;
        console.error('Webhook error', resp.status, text);
        return;
      }
      // הצלחה — הצג את הגוף המוחזר (Google Chat מחזיר JSON עם ה-message)
      logEl.textContent = `נשלח בהצלחה! HTTP ${resp.status}\nResponse body:\n${text}`;
      console.log('Webhook response:', text);
    }catch(err){
      console.error('Fetch error', err);
      logEl.textContent = 'שגיאה בשליחה (fetch): ' + err.message;
    }
  }

  document.getElementById('build').addEventListener('click', ()=> renderPreview());
  document.getElementById('send').addEventListener('click', async ()=>{
    const payload = buildPayload();
    renderPreview(payload);
    saveHistory(payload);
    await sendToWebhook(payload);
    if(document.getElementById('after').value === 'clear'){
      ['plainText','title','subtitle','headerImage','cardText','images'].forEach(id => { const el=document.getElementById(id); if(el) el.value = ''; });
      renderImagesPreview(); renderPreview();
    }
  });

  renderHistory();

});
</script>
</body>
</html>
